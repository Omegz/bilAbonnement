<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Skade og udbedring - Skadesrapport</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        .card { max-width: 900px; border: 1px solid #ddd; padding: 18px; border-radius: 10px; }
        .row { display: flex; gap: 12px; margin-bottom: 12px; }
        .field { flex: 1; }
        label { display:block; margin-bottom: 6px; font-weight: 600; }
        select, input, button { width: 100%; padding: 8px; font-size: 14px; }
        button { width: auto; cursor: pointer; }
        .fejl { color: #b00020; margin: 10px 0; }
        .hint { font-size: 12px; color: #666; margin-top: 6px; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f6f6f6; text-align: left; }
        .actions { display:flex; gap: 8px; }
        .small { width: 160px; }
    </style>
</head>
<body>

<h1>Skade og udbedring: Skadesrapport</h1>

<div class="card">

    <div th:if="${fejl}" class="fejl" th:text="${fejl}"></div>

    <!-- Filter: vælg kunde og derefter kontrakt -->
    <form th:action="@{/skader/opret}" method="get">
        <div class="row">
            <div class="field">
                <label for="kundeId">Filtrer på kunde</label>
                <select id="kundeId" name="kundeId" onchange="this.form.submit()">
                    <option value="">-- alle kunder --</option>
                    <option th:each="k : ${kunder}"
                            th:value="${k.id}"
                            th:text="${k.navn}"
                            th:selected="${selectedKundeId != null and selectedKundeId == k.id}">
                    </option>
                </select>
                <div class="hint">Vi viser kun kontrakter hvor lejeperioden er overstået (slutdato ≤ i dag).</div>
            </div>

            <div class="field">
                <label for="abonnementId">Vælg kontrakt (abonnement)</label>
                <select id="abonnementId" name="abonnementId" onchange="this.form.submit()">
                    <option value="">-- vælg kontrakt --</option>
                    <option th:each="a : ${abonnementer}"
                            th:value="${a.abonnementId}"
                            th:text="${a.kundeNavn + ' - ' + a.bilNavn + ' (slut: ' + a.slutdato + ')'}"
                            th:selected="${selectedAbonnementId != null and selectedAbonnementId == a.abonnementId}">
                    </option>
                </select>
            </div>
        </div>
    </form>

    <hr style="margin: 16px 0;">

    <!-- Opret skader -->
    <form th:action="@{/skader/opret}" method="post">
        <input type="hidden" name="kundeId" th:value="${selectedKundeId}">
        <input type="hidden" name="abonnementId" th:value="${selectedAbonnementId}">

        <div class="hint" th:if="${selectedAbonnementId == null}">
            Vælg først en kontrakt for at kunne oprette en skadesrapport.
        </div>

        <div th:if="${selectedAbonnementId != null}">
            <h2>Tilføj skader</h2>

            <table id="skadeTable">
                <thead>
                <tr>
                    <th>Beskrivelse</th>
                    <th class="small">Pris (DKK)</th>
                    <th class="small">Handling</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td><input name="beskrivelse" type="text" placeholder="Fx Ridse på dør" required></td>
                    <td><input name="pris" type="number" step="0.01" placeholder="Fx 1500" required></td>
                    <td class="actions">
                        <button type="button" onclick="addRow()">+ Tilføj</button>
                        <button type="button" onclick="removeRow(this)">Fjern</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <hr style="margin: 16px 0;">

            <div class="row">
                <div class="field">
                    <label for="medarbejderNavn">Medarbejder-navn</label>
                    <input id="medarbejderNavn" name="medarbejderNavn" type="text" required>
                </div>
                <div class="field">
                    <label for="medarbejderPassword">Medarbejder-password</label>
                    <input id="medarbejderPassword" name="medarbejderPassword" type="password" required>
                </div>
            </div>

            <div class="hint">MVP: ekstra kontrol ved submit. Kun SKADE_OG_UDBEDRING må gemme skader.</div>

            <div style="margin-top: 14px;">
                <button type="submit">Gem skadesrapport</button>
            </div>
        </div>
    </form>

    <div th:if="${selectedAbonnementId != null}">
        <h2 style="margin-top: 22px;">Eksisterende skader på kontrakten</h2>
        <table th:if="${skader != null}">
            <thead>
            <tr>
                <th>ID</th>
                <th>Beskrivelse</th>
                <th>Pris</th>
                <th>Oprettet</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s : ${skader}">
                <td th:text="${s.get('id')}"></td>
                <td th:text="${s.get('beskrivelse')}"></td>
                <td th:text="${s.get('pris')}"></td>
                <td th:text="${s.get('oprettet_dato')}"></td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<script>
    function addRow() {
        const tbody = document.querySelector("#skadeTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td><input name="beskrivelse" type="text" placeholder="Fx Ridse på dør" required></td>
      <td><input name="pris" type="number" step="0.01" placeholder="Fx 1500" required></td>
      <td class="actions">
        <button type="button" onclick="addRow()">+ Tilføj</button>
        <button type="button" onclick="removeRow(this)">Fjern</button>
      </td>
    `;
        tbody.appendChild(tr);
    }

    function removeRow(btn) {
        const tbody = document.querySelector("#skadeTable tbody");
        if (tbody.rows.length <= 1) return; // behold mindst én række
        btn.closest("tr").remove();
    }
</script>

</body>
</html>
